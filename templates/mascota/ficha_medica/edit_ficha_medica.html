{% extends "base/base.html" %}
{% load static %}

{% block title %} Editar Ficha Médica {% endblock title %}

{% block css %}
{{ block.super }}

<style>

  .text_align_center {
    text-align-last: center;
}

.card-pets:hover {
    box-shadow: 0px 0px 10px 5px #a6a6a6;
    /* please set the shadow color conveniently */
}

.card-pets {
    border-radius: 10px !important;
}

.card-img-div {
    background-color: #278094eb;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
}

.rd-card-img {
    height: 8rem;
    width: 8rem;
    border-radius: 4rem;
    margin-left: auto;
    margin-right: auto;
    border: 1px solid rgba(52, 73, 94, 0.44);
    background: #fff;
    padding: 4px;
}

.edit-property {
    font-size: 18px;
    margin-right: 7px;
    position: relative;
    margin-top: .5rem;
    color: #ffff;
}

/*.dropdown-item {
    padding: 0.25rem 0.5rem;
    cursor: pointer;
}

a.dropdown-item {
    color: #45474a;
    padding: 0rem .5rem;
}

a.dropdown-item:hover {
    background: rgba(0, 0, 0, .1);
}*/

.card-option {
    background-color: #fff;
    position: absolute;
    right: 1rem;
    top: 2.5rem;
    width: 8.5rem;
    height: auto;
    background-color: #fff;
    border-radius: 5px;
    -webkit-box-shadow: -1px 3px 19px -2px rgba(0, 0, 0, 0.72);
    -moz-box-shadow: -1px 3px 19px -2px rgba(0, 0, 0, 0.72);
    box-shadow: -1px 3px 19px -2px rgba(0, 0, 0, 0.72);
}

.rd_line_medical_lila {
    border-bottom: 1px solid #267fb3;
}

.rd_background_consultas {
    background-color: #267fb3;
}

.rd_line_medical_red {
    border-bottom: 1px solid #e52121;
}

.rd_background_vacunas {
    background-color: #e52121;
}

.rd_line_medical_gren {
    border-bottom: 1px solid #588057;
}

.rd_background_antiparasitarios {
    background-color: #588057;
}

.rd_align_text_medical {
    margin: auto;
    padding: 10px;
    text-align: center;
    font-size: 30px;
}

.rd_icon {
    color: black;
}

.select2{
    width: 100% !important;
}
</style>
{% endblock css %}

{% block content %}
 <!-- Content Header (Page header) -->
 <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Lista de Mascota
          </h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
            <li class="breadcrumb-item active">Mascotas</li>
          </ol>
        </div>
      </div>
    </div><!-- /.container-fluid -->
  </section>

  <!-- Main content -->
   <!-- Main content -->
   <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">            
            <div class="card-header">
              <div class="float-left">                
              </div>             
            </div>
            <!-- /.card-header -->
              <!-- Default box -->
              <div >
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-4 col-md-9 col-sm-12">
                            <div class="card card-pets">
                                <div class="card-img-div text_align_center">
        
                                    <div class="">
                                        <img class="card-img-top rd-card-img" src="{{ mascota.get_profile}} "
                                            alt="pets profile image"
                                            style="margin-top: .5rem; margin-bottom: .5rem; margin-left: 7px;">
                                    </div>
        
                                </div>
                                <h5 class="text_align_center" style="margin-top: .5rem;">{{ mascota.nombre_mascota}}
                                </h5>
                                <div class="card-body card-body-pets p-0" style="margin-top: 6px;">
                                    <div class="status m-0">
                                        <p class="text-uppercase text_align_center  m-0">
                                            {{ mascota.id_cliente.nombre_cliente }} {{ mascota.id_cliente.apellido_cliente }} </p>
                                    </div>
                                    <div class="status m-0">
                                        <p class="text-uppercase text_align_center m-0">{{ mascota.id_raza.id_especie.nombre_especie}}</p>
                                    </div>
                                    <div class="status m-0">
                                        <p class="text-uppercase text_align_center m-0">{{ mascota.id_raza.nombre_raza }}</p>
                                    </div>
                                    <div class="status">
                                        <p class="text-uppercase text_align_center">{{ mascota.peso}}</p>
                                    </div>
                                </div>
        
                                <div class="status mt-2 mb-2" style="margin: 0 auto !important; padding-bottom: 9px;">
                                    <a class="btn btn-outline-primary text_align_center" 
                                     href="{% url 'mascota:list_historial' mascota.id %}">
                                        Ver Historial
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-10 col-md-8 col-sm-12 p-0">
                            <form action="{% url 'mascota:edit_ficha_medica' mascota.id %}" method="POST">
                                {% csrf_token %}
                                <div class="x_panel pt-0" style="padding-left: 10px; padding-right: 10px;">
                                    <div class="row rd_option_medical" style="cursor: pointer;">
                                        <div class="col rd_line_medical_lila rd_align_text_medical consultas"
                                            id="consultas_medical">
                                            <i data-toggle="tooltip" data-placement="top" title="Ficha"
                                                class="fas fa-folder-open icon_consultas"></i>
                                        </div>
                                        <div class="col rd_line_medical_red rd_align_text_medical vacunas"
                                            id="vacunas_medical">
                                            <i data-toggle="tooltip" data-placement="top" title="Vacunas"
                                                class="fas fa-syringe icon_vacunas"></i>
                                        </div>                                     
                                    </div>
                                    <div class="container_ficha" id="">
                                        <div class="p-2">
                                            <h3>Ficha</h3>
                                        </div>
                                    <diV class="row">
                                        <div class="col-lg-4 col-md-9 col-sm-9">
                                            <div class="mb-3 row">
                                                <label for="" class="col-sm-12 col-form-label"
                                                    style="font-size: 16px;">Peso
                                                </label>
                                                <div class="col-sm-12">
                                                    <p class="m-0">{{ mascota.peso }}</p>
                                                </div>
                                            </div>
                                            <div class="mb-3 row">
                                                <label for="" class="col-sm-12 col-form-label"
                                                    style="font-size: 16px;">Sexo
                                                </label>
                                                <div class="col-sm-12">
                                                    <p class="m-0">
                                                        {% if mascota.sexo == HEB  %}
                                                            Hembra
                                                        {% else %}
                                                            Macho
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 col-md-9 col-sm-9">
                                            <div class="mb-3 row">
                                                <label for="" class="col-sm-12 col-form-label"
                                                    style="font-size: 16px;">Edad
                                                </label>
                                                <div class="col-sm-12">
                                                    <p class="m-0">
                                                        {% if mascota.edad  == None %}
                                                            -
                                                        {% else %}
                                                            {{ mascota.edad }}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="mb-3 row">
                                                <label for="" class="col-sm-12 col-form-label"
                                                    style="font-size: 16px;">Fecha Nacimiento
                                                </label>
                                                <div class="col-sm-12">
                                                    <p class="m-0">
                                                        {% if  mascota.fecha_nacimiento == None %}
                                                            -
                                                        {% else %}
                                                            {{ mascota.fecha_nacimiento }}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-lg-4 col-md-9 col-sm-9">
                                            <div class="mb-3 row">
                                                <label for="" class="col-sm-12 col-form-label"
                                                    style="font-size: 16px;">Color Pelaje
                                                </label>
                                                <div class="col-sm-12">
                                                    <p class="m-0">
                                                    {% if  mascota.color_pelaje == '#000000' %}
                                                        -
                                                    {% else %}
                                                        <input type="color" value="{{ mascota.color_pelaje }}" 
                                                        readonly="readonly" disabled="disabled"/>                                                            
                                                    {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="mb-3 row">
                                                <label for="" class="col-sm-12 col-form-label"
                                                    style="font-size: 16px;">Tatuaje
                                                </label>
                                                <div class="col-sm-12">
                                                    <p class="m-0">
                                                        {% if  mascota.tatuaje == None %}
                                                            -
                                                        {% else %}
                                                            {{ mascota.tatuaje }}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                       
                                    </div>
                                    <div class="container_vacunas d-none" id="">
                                        <div class="p-2">
                                            <h3>Vacunas</h3>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-4 col-md-9 col-sm-9">
                                                <div class="mb-3 row">
                                                    <label for="" class="col-sm-12 col-form-label"
                                                        style="font-size: 16px;">Vacuna Aplicada
                                                    </label>
                                                    <div class="col-sm-12">
                                                        <p class="m-0">
                                                            <select class="form-control" name="id_vacuna" id="id_vacuna">
                                                                <option>-------</option>
                                                                {% for vacu in vacunas_aplicada %}
                                                                    <option value="{{ vacu.id }}"> {{ vacu.nombre_vacuna }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
    
                                            <div class="col-lg-4 col-md-9 col-sm-9 d-none" id="proxima_vacuna">
                                                <div class="mb-3 row">
                                                    <label for="" class="col-sm-12 col-form-label"
                                                        style="font-size: 16px;">Próxima Vacuna a Aplicar
                                                    </label>
                                                    <div class="col-sm-12">
                                                        <p class="m-0" id="list_vacunas_proximas">
                                                        
                                                        </p>
                                                    </div>
                                                </div> 
                                            </div>

                                            <div class="col-lg-4 col-md-9 col-sm-9">
                                                <div class="mb-3 row">
                                                    <label for="" class="col-sm-12 col-form-label"
                                                        style="font-size: 16px;">Fecha Aplicación
                                                    </label>
                                                    <div class="col-sm-12">
                                                        <p class="m-0">
                                                            {{ formVacuna.fecha_aplicacion }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-4 col-md-9 col-sm-9">
                                                <div class="mb-3 row">
                                                    <label for="" class="col-sm-12 col-form-label"
                                                        style="font-size: 16px;">Fecha Próxima Aplicación
                                                    </label>
                                                    <div class="col-sm-12">
                                                        <p class="m-0">
                                                            {{ formVacuna.fecha_proxima_aplicacion }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>                                       
                                       
                                    </div>                                   
                                </div>
                                <div class="ln_solid">
                                    <div class="form-group">
                                        <div class="col-md-6 offset-md-3" style="margin-top: 1rem; text-align: center;">
                                            <input type="hidden" name="id_mascota" id="id_mascota"
                                                value="{{ mascota.id }}">
                                            <input type="hidden" name="id_ficha_medica" id="id_ficha_medica"
                                                value="{{ fichaMedicaGet.id }}">
                                            <button type="button" class="btn btn-primary" id="btn_actualizar">Actualizar</button>
                                            <button class="btn btn-success">
                                                <a style="color: white; cursor: pointer;"
                                                    href="{% url  'mascota:list_mascotas'%}">
                                                    Volver
                                                </a>
                                                </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>   
                    </div>
                                             
                </div>              
              </div>
                    <!-- /.card -->
            <!-- /.card-body -->
          </div>                    
          <!-- /.card -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
  </section>
  
<div class="modal fade" id="creacion" role="dialog"> </div>

<div class="modal fade" id="edicion" role="dialog"> </div>

<div class="modal fade" id="eliminacion" role="dialog">

</div>


{% endblock content %}

{% block js_page %}
{{ block.super }}
<!-- Datatables -->
<script>
    $.datepicker.regional['es'] = {
        closeText: 'Cerrar',
        prevText: '< Ant',
        nextText: 'Sig >',
        currentText: 'Hoy',
        monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
        monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
        dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
        dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Juv', 'Vie', 'Sáb'],
        dayNamesMin: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sá'],
        weekHeader: 'Sm',
        dateFormat: 'dd/mm/yy',
        firstDay: 1,
        isRTL: false,
        showMonthAfterYear: false,
        yearSuffix: ''
    };
    $.datepicker.setDefaults($.datepicker.regional['es']);

    $(function () {
        $('input').on("cut copy paste",function(e) {
            e.preventDefault();
        });

        $('.rd_option_medical').find('.consultas').addClass('rd_background_consultas');
        $('.rd_option_medical').find('.icon_consultas').addClass('rd_icon');
        $('#consultas_medical').click(function () {
            $('.rd_option_medical').find('.consultas').addClass('rd_background_consultas');
            $('.rd_option_medical').find('.vacunas').removeClass('rd_background_vacunas');
            $('.rd_option_medical').find('.antiparasitarios').removeClass('rd_background_antiparasitarios');
            $('.rd_option_medical').find('.icon_consultas').addClass('rd_icon');
            $('.rd_option_medical').find('.icon_antiparasitario').removeClass('rd_icon');
            $('.rd_option_medical').find('.icon_vacunas').removeClass('rd_icon');
            $('.x_panel').find('.container_ficha').removeClass('d-none');
            $('.x_panel').find('.container_vacunas').addClass('d-none');
            $('.x_panel').find('.container_antiparasitarios').addClass('d-none');

        })

        $('#vacunas_medical').click(function () {
            $('.rd_option_medical').find('.vacunas').addClass('rd_background_vacunas');
            $('.rd_option_medical').find('.consultas').removeClass('rd_background_consultas');
            $('.rd_option_medical').find('.antiparasitarios').removeClass('rd_background_antiparasitarios');
            $('.rd_option_medical').find('.icon_vacunas').addClass('rd_icon');
            $('.rd_option_medical').find('.icon_consultas').removeClass('rd_icon');
            $('.rd_option_medical').find('.icon_antiparasitario').removeClass('rd_icon');
            $('.x_panel').find('.container_ficha').addClass('d-none');
            $('.x_panel').find('.container_antiparasitarios').addClass('d-none');
            $('.x_panel').find('.container_vacunas').removeClass('d-none');
        })

        $('#antiparasitarios_medical').click(function () {
            $('.rd_option_medical').find('.antiparasitarios').addClass('rd_background_antiparasitarios');
            $('.rd_option_medical').find('.vacunas').removeClass('rd_background_vacunas');
            $('.rd_option_medical').find('.consultas').removeClass('rd_background_consultas');
            $('.rd_option_medical').find('.icon_antiparasitario').addClass('rd_icon');
            $('.rd_option_medical').find('.icon_vacunas').removeClass('rd_icon');
            $('.rd_option_medical').find('.icon_consultas').removeClass('rd_icon');
            $('.x_panel').find('.container_ficha').addClass('d-none');
            $('.x_panel').find('.container_vacunas').addClass('d-none');
            $('.x_panel').find('.container_antiparasitarios').removeClass('d-none');
        })

        $('form input').on("cut copy paste",function(e) {
            e.preventDefault();
        });
        $('form textarea').on("cut copy paste",function(e) {
            e.preventDefault();
        });

        $('#datePick-aplicacion').datepicker({
            format: "dd/mm/yyyy",
            autoclose: true,
        }).datepicker("setDate", new Date());;

        $('#datePick-proxima-aplicacion').datepicker({
                                format: "dd/mm/yyyy",
                                autoclose: true,
                }); 

        $(document).on('change', "#proxima_vacunacion", function(){
            var tipo = $("#proxima_vacunacion").val() == "-------" ? "" : $("#proxima_vacunacion").val();
            sessionStorage.setItem('proxima_vacunacion', tipo)
            if (tipo !== "") {
                $.ajax({
                    type: 'GET',
                    url: '/configuracion/get_periodo_vacunacion/',
                    data: { 'tipo': tipo },
                    success: function (response) {
                        if(response.mensaje === ""){
                            var today = new Date()
                            today.setMonth(today.getMonth() + parseInt(response.periodo))
                            $('#datePick-proxima-aplicacion').datepicker({
                                format: "dd/mm/yyyy",
                                autoclose: true,
                            }).datepicker("setDate", today);;

                        }else{
                            $('#datePick-proxima-aplicacion').datepicker({
                                format: "dd/mm/yyyy",
                                autoclose: true,
                            }).datepicker("setDate",  new Date());;
                        }
                        
                    }
                })
            }else{
                $('#datePick-proxima-aplicacion').datepicker({
                                format: "dd/mm/yyyy",
                                autoclose: true,
                }).datepicker('setDate', null) 
                sessionStorage.setItem('proxima_vacunacion', "")
                sessionStorage.setItem('vacuna_aplicada', id_vacuna)
                $("form").find("#proxima_vacuna").addClass('d-none')
            }
        })

        $('#proximo_antipara').select2({
            ajax: {
                type: 'POST',
                url: '/producto/get_producto_antiparasitario/',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term,
                        action: 'search_products'
                    };
                },
                processResults: function (data) {
                    return {
                        results: data
                    }
                },
            },
            language: {
                inputTooShort: function () {
                    return '';
                },
                searching: function () {
                    return 'Buscando...'
                },
                noResults: function () {
                    return 'No se ha encontrado ningún resultado'
                }
            }
        })

        $('#antipara').select2({
            ajax: {
                type: 'POST',
                url: '/producto/get_producto_antiparasitario/',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term,
                        action: 'search_products'
                    };
                },
                processResults: function (data) {
                    return {
                        results: data
                    }
                },
            },
            language: {
                inputTooShort: function () {
                    return '';
                },
                searching: function () {
                    return 'Buscando...'
                },
                noResults: function () {
                    return 'No se ha encontrado ningún resultado'
                }
            }
        })

        $("#id_vacuna").change(function(){
            var id_vacuna = $(this).val() == "-------" ? "" : $(this).val();
            sessionStorage.setItem('vacuna_aplicada', id_vacuna)
            if (id_vacuna !== ""){
                var ficha_id = "{{ fichaMedicaGet.id }}";
                $.ajax({
                    url: "/mascota/get_prox_vacuna/",
                    type: "GET",
                    data: {"id_vacuna": id_vacuna, 'ficha_id': ficha_id},
                    success: function(response){
                        var prox_vacunas = JSON.parse(response.proximas_vacunas);
                        var selectVac = '<select class="form-control" name="proxima_vacunacion" id="proxima_vacunacion">\
                                                <option>-------</option>';
                        $.each(prox_vacunas, function (i, data) {
                            selectVac += "<option value='" + data.id + "'>" + data.nombre_vacuna + "</option>";
                        });

                        selectVac += '</select>';
                        $("form").find("#proxima_vacuna").removeClass("d-none");
                        $("#list_vacunas_proximas").html(selectVac)
                        sessionStorage.setItem('proxima_vacunacion', "")

                    },
                    error: function(error){

                    },
                })
            }
            else{
                $('#datePick-proxima-aplicacion').datepicker({
                                format: "dd/mm/yyyy",
                                autoclose: true,
                }).datepicker('setDate', null) 
                sessionStorage.setItem('proxima_vacunacion', "")
                sessionStorage.setItem('vacuna_aplicada', id_vacuna)
                $("form").find("#proxima_vacuna").addClass("d-none");
            }
        })

        $("#btn_actualizar").click(function(event) {
            var vacuna_aplicada = sessionStorage.getItem("vacuna_aplicada")
            var proxima_vacuna = sessionStorage.getItem("proxima_vacunacion")
            if( vacuna_aplicada == "" || (vacuna_aplicada != "" && proxima_vacuna != "")){
                $("#datePick-proxima-aplicacion").prop("disabled", false)
                $('form').submit()
            }
            else{              
                warning_registro("Debes seleccionar la proxima vacuna!")
                event.preventDefault()
            }
        });
        


        {% if messages %}
          {% for message in messages %}
            var text = "{{ message }}";
            add_edit_registro(text);
          {% endfor %}
        {% endif %}
    })
</script>


{% endblock js_page %}